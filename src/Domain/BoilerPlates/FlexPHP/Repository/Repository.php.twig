{% set fkFnsNoBlame = fkFns|filter(v => not v.blameBy) %}
<?php declare(strict_types=1);

namespace Domain\{{ entity }};

{% for request in requests %}
use Domain\{{ entity }}\Request\{{ request }}{{ entity }}Request;
{% endfor %}
{% for id,fkFn in fkFnsNoBlame %}
use Domain\{{ entity }}\Request\Find{{ entity }}{{ fkFn.fnSingular }}Request;
{% endfor %}
use FlexPHP\Repositories\Repository;

final class {{ entity }}Repository extends Repository
{
{% for action in actions %}
{% if action in ['index'] %}
    public function findBy(Index{{ entity }}Request $request): array
    {
        return array_map(function (array ${{ item }}) {
            return (new {{ entity }}Factory())->make(${{ item }});
        }, $this->getGateway()->search((array)$request, [], $request->page, 10));
    }
{% elseif action in ['create'] %}
    public function add(Create{{ entity }}Request $request): void
    {
        ${{ item }} = (new {{ entity }}Factory())->make($request);

        $this->getGateway()->push(${{ item }});
    }
{% elseif action in ['read'] %}
    public function getById(Read{{ entity }}Request $request): {{ entity }}
    {
        $factory = new {{ entity }}Factory();
        $data = $this->getGateway()->get($factory->make($request));

        return $factory->make($data);
    }
{% elseif action in ['update'] %}
    public function change(Update{{ entity }}Request $request): void
    {
        ${{ item }} = (new {{ entity }}Factory())->make($request);

        $this->getGateway()->shift(${{ item }});
    }
{% elseif action in ['delete'] %}
    public function remove(Delete{{ entity }}Request $request): void
    {
        ${{ item }} = (new {{ entity }}Factory())->make($request);

        $this->getGateway()->pop(${{ item }});
    }
{% elseif action in ['login'] %}
    public function getByLogin(Login{{ entity }}Request $request): {{ entity }}
    {
        $data = $this->getGateway()->getBy('{{ login }}', $request->{{ login }});

        return (new {{ entity }}Factory())->make($data);
    }
{% endif %}
{% if not loop.last %}

{% endif %}
{% endfor %}
{% for id,fkFn in fkFnsNoBlame %}

    public function find{{ fkFn.fnPlural }}ByTerm(Find{{ entity }}{{ fkFn.fnSingular }}Request $request): array
    {
        return $this->getGateway()->filter{{ fkFn.fnPlural }}($request->term, $request->page, 10);
    }
{% endfor %}
}
