<?php declare(strict_types=1);

namespace Domain\{{ entity }}\Gateway;

use Domain\{{ entity }}\{{ entity }};
use Domain\{{ entity }}\{{ entity }}Gateway;
use Doctrine\DBAL\Connection;
use Doctrine\DBAL\Types\Types as DB;

final class MySQL{{ entity }}Gateway implements {{ entity }}Gateway
{
    private $query;
    private $table = '{{ table }}';

    public function __construct(Connection $conn)
    {
        $this->query = $conn->createQueryBuilder();
    }
{% for action in actions %}
{% if action in ['index'] %}

    public function search(array $wheres, array $orders, int $limit): array
    {
        $this->query->select([
{% for id, property in properties %}
{% if not property.isBlame %}
            '{{ property.name }} as {{ id }}',
{% endif %}
{% endfor %}
        ]);
        $this->query->from($this->table);

        foreach($wheres as $column => $value) {
            if (!$value) {
                continue;
            }

            $this->query->where("{$column} = :{$column}");
            $this->query->setParameter(":{$column}", $value);
        }

        $this->query->setMaxResults($limit);

        return $this->query->execute()->fetchAll();
    }
{% elseif action in ['create'] %}

    public function push({{ entity }} ${{ item }}): void
    {
        $this->query->insert($this->table);

{% for id, property in properties %}
{% if not property.isAi and not property.isUb %}
        $this->query->setValue('{{ property.name }}', ':{{ id }}');
{% endif %}
{% endfor %}

{% for id, property in properties %}
{% if not property.isAi and not property.isBlameAt and not property.isUb %}
        $this->query->setParameter(':{{ id }}', ${{ item }}->{{ id }}(), DB::{{ dbTypes[id] }});
{% elseif property.isBlameAt %}
        $this->query->setParameter(':{{ id }}', new \DateTime(date('Y-m-d H:i:s')), DB::{{ dbTypes[id] }});
{% endif %}
{% endfor %}

        $this->query->execute();
    }
{% elseif action in ['read'] %}

    public function get({{ entity }} ${{ item }}): array
    {
        $this->query->select([
{% for id, property in properties %}
            '{{ item }}.{{ property.name }} as {{ id }}',
{% endfor %}
{% for id, fkRel in fkRels %}
            '{{ fkRel.pkName }}.{{ fkRel.id }} as `{{ fkRel.pkName }}.{{ fkRel.id }}`',
            '{{ fkRel.pkName }}.{{ fkRel.text }} as `{{ fkRel.pkName }}.{{ fkRel.text }}`',
{% endfor %}
        ]);
        $this->query->from($this->table, '{{ item }}');
{% for id, fkRel in fkRels %}
{% set joinType = fkRel.required ? 'join' : 'leftJoin' %}
        $this->query->{{ joinType }}('{{ item }}', '{{ fkRel.table }}', '{{ fkRel.pkName }}', '{{ item }}.{{ fkRel.pk }} = {{ fkRel.pkName }}.{{ fkRel.id }}');
{% endfor %}
        $this->query->where('{{ item }}.{{ properties[pkName].name }} = :{{ pkName }}');
        $this->query->setParameter(':{{ pkName }}', ${{ item }}->{{ pkName }}(), DB::{{ dbTypes[pkName] }});

        return $this->query->execute()->fetch() ?: [];
    }
{% elseif action in ['update'] %}

    public function shift({{ entity }} ${{ item }}): void
    {
        $this->query->update($this->table);

{% for id, property in properties %}
{% if not property.isAi and not property.isCa and not property.isCb %}
        $this->query->set('{{ property.name }}', ':{{ id }}');
{% endif %}
{% endfor %}

{% for id, property in properties %}
{% if not property.isAi and not property.isBlameAt and not property.isCb %}
        $this->query->setParameter(':{{ id }}', ${{ item }}->{{ id }}(), DB::{{ dbTypes[id] }});
{% elseif property.isBlameAt and property.isUa %}
        $this->query->setParameter(':{{ id }}', new \DateTime(date('Y-m-d H:i:s')), DB::{{ dbTypes[id] }});
{% endif %}
{% endfor %}

        $this->query->where('{{ properties[pkName].name }} = :{{ pkName }}');
        $this->query->setParameter(':{{ pkName }}', ${{ item }}->{{ pkName }}(), DB::{{ dbTypes[pkName] }});

        $this->query->execute();
    }
{% elseif action in ['delete'] %}

    public function pop({{ entity }} ${{ item }}): void
    {
        $this->query->delete($this->table);

        $this->query->where('{{ properties[pkName].name }} = :{{ pkName }}');
        $this->query->setParameter(':{{ pkName }}', ${{ item }}->{{ pkName }}(), DB::{{ dbTypes[pkName] }});

        $this->query->execute();
    }
{% elseif action in ['login'] %}

    public function getBy(string $column, $value): array
    {
        $this->query->select([
{% for id, property in properties %}
            '{{ property.name }} as {{ id }}',
{% endfor %}
        ]);
        $this->query->from($this->table);
        $this->query->where($column . ' = :column');
        $this->query->setParameter(':column', $value);

        $data = $this->query->execute()->fetch();

        return is_array($data) ? $data : [];
    }
{% endif %}
{% endfor %}
{% for id,fkFn in fkFns %}

    public function filter{{ fkFn.fnPlural }}(string $term, int $page, int $limit): array
    {
        $this->query->select([
            '{{ fkFn.id }} id',
            '{{ fkFn.text }} text',
        ]);
        $this->query->from('{{ fkFn.table }}');

        $this->query->where('{{ fkFn.text }} like :{{ fkFn.text }}');
        $this->query->setParameter(':{{ fkFn.text }}', "%{$term}%");

        $this->query->setMaxResults($limit);

        return $this->query->execute()->fetchAll();
    }
{% endfor %}
}
